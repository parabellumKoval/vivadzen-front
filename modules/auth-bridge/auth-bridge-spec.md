# **Техническое задание: доработка модуля `modules/auth-bridge` (Nuxt 3) и `plugins/api`**

## **1. Цель**

Расширить функциональность модуля `auth-bridge`, чтобы он: - корректно
обрабатывал авторизацию через Laravel Socialite (OAuth); - обеспечивал
авторизацию пользователя на фронтенде по токену, переданному в URL; -
реализовал поддержку и хранение реферального (спонсорского) кода с TTL и
валидацией через API.

------------------------------------------------------------------------

## **2. OAuth-авторизация**

### **2.1. Общий процесс**

1.  Пользователь проходит авторизацию или регистрацию через Laravel
    Socialite.\

2.  После успешного входа бекенд перенаправляет на фронтенд с
    query-параметром:

        ?token=<auth_token>

    Пример:\
    `https://example.com/?token=5|ttVmhJ73cYNYWMs0SSOewYsvycYbn82mXDGDmb55e8f62af8`

3.  Модуль `auth-bridge` должен:

    -   перехватывать этот параметр `token`;
    -   вызывать внутренний метод авторизации, используя этот токен для
        входа пользователя;
    -   сохранять токен (например, в cookie или локальном хранилище) для
        последующих запросов;
    -   обеспечивать авторизацию пользователя **с любой страницы
        сайта**, если в URL присутствует `token`.

### **2.2. Требования к реализации**

-   Авторизация по токену должна выполняться **автоматически**, без
    участия пользователя.

------------------------------------------------------------------------

## **3. Реферальная система**

### **3.1. Общая логика**

1.  Любая страница сайта может содержать query-параметр со спонсорским
    кодом (например, `?ref=DJINI123`).
2.  Если пользователь заходит с таким параметром:
    -   код проверяется через API;
    -   при успешной проверке сохраняется (в cookie, localStorage или
        другой персистентной форме);
    -   хранится заданное время (TTL);
    -   после истечения TTL код становится неактивным.
3.  Новый спонсорский код может быть установлен **только** если:
    -   у пользователя ещё нет активного кода, **или**
    -   истёк TTL предыдущего.

------------------------------------------------------------------------

### **3.2. Проверка валидности кода**

Перед установкой кода необходимо сделать запрос к API, вместо :code подставляем спонсорский код:

    GET <validateReferralCode>

(точный endpoint берётся из конфигурации модуля)

Ответ API:

``` json
true // или false
```

Только при `true` код сохраняется.

------------------------------------------------------------------------

### **3.3. Хранение и использование кода**

-   Код должен сохраняться с учётом TTL.
-   Код необходимо автоматически добавлять во все запросы к API,
    отправляемые через `$api`.
-   В частности, при:
    -   регистрации/авторизации пользователя,
    -   создании заказов,
    -   других API-запросах, где это требуется.

Рекомендуется реализовать это на уровне плагина `plugins/api.ts`, чтобы
код автоматически добавлялся во все запросы.

------------------------------------------------------------------------

### **3.4. Настройки и параметры**

Модуль должен поддерживать конфигурацию по ключам:

  -------------------------------------------------------------------------------------------------------------------
  Параметр                            Описание           Источник                       Значение по умолчанию
  ----------------------------------- ------------------ ------------------------------ -----------------------------
  `profile.referrals.url_param`       Имя                `modules/settings` →           `"ref"`
                                      query-параметра,   `useSettings().get()` или      
                                      через который      `useNuxtApp().$getSetting()`   
                                      передаётся                                        
                                      реферальный код                                   

  `profile.referrals.link_ttl_days`   Время жизни кода   `modules/settings` →           `30`
                                      (в днях)           `useSettings().get()` или      
                                                         `useNuxtApp().$getSetting()`   
  -------------------------------------------------------------------------------------------------------------------

Если модуль `settings` недоступен или настройки отсутствуют ---
используются значения по умолчанию из конфигурации модуля.
